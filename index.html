<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrevista MMG</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --white: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.05);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    header {
      background-color: var(--white);
      box-shadow: var(--shadow-sm);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon {
      width: 32px;
      height: 32px;
      background-color: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    h2 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 1.5rem;
    }
    
    h3 {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--dark);
    }
    
    .card {
      background-color: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: 25px;
      margin-bottom: 30px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    /* Estilos do Chat */
    #chatContainer {
      display: flex;
      flex-direction: column;
      height: 500px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background-color: var(--white);
      box-shadow: var(--shadow-sm);
    }
    
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: var(--white);
      scrollbar-width: thin;
      scrollbar-color: var(--light-gray) var(--white);
    }
    
    #chatMessages::-webkit-scrollbar {
      width: 6px;
    }
    
    #chatMessages::-webkit-scrollbar-track {
      background: var(--white);
    }
    
    #chatMessages::-webkit-scrollbar-thumb {
      background-color: var(--light-gray);
      border-radius: 3px;
    }
    
    .message {
      margin-bottom: 15px;
      max-width: 80%;
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bot-message {
      background-color: var(--light);
      border-bottom-left-radius: var(--radius-sm);
      margin-right: auto;
      border: 1px solid var(--light-gray);
    }
    
    .bot-message strong {
      font-weight: 600;
      color: var(--dark);
    }
    
    .user-message {
      background-color: var(--primary);
      color: var(--white);
      border-bottom-right-radius: var(--radius-sm);
      margin-left: auto;
    }
    
    #chatInputArea {
      padding: 15px;
      background-color: var(--light);
      border-top: 1px solid var(--light-gray);
    }
    
    .input-group {
      display: flex;
      gap: 10px;
    }
    
    .input-group input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      font-size: 16px;
      transition: var(--transition);
    }
    
    .input-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .input-group button {
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      padding: 0 20px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .input-group button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .input-group button:active {
      transform: translateY(0);
    }
    
    /* Estilos para upload de arquivos */
    .file-upload {
      margin-top: 10px;
      width: 100%;
    }
    
    .file-upload label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .file-input-container {
      position: relative;
      width: 100%;
    }
    
    .file-input-label {
      display: block;
      padding: 12px;
      border: 2px dashed var(--light-gray);
      border-radius: var(--radius-sm);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .file-input-label:hover {
      border-color: var(--primary);
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .file-input {
      position: absolute;
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      z-index: -1;
    }
    
    .file-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    
    .file-preview {
      position: relative;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      overflow: hidden;
      transition: var(--transition);
    }
    
    .file-preview:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-sm);
    }
    
    .file-preview img {
      display: block;
      width: 120px;
      height: 120px;
      object-fit: cover;
    }
    
    .file-preview .file-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 5px;
      font-size: 11px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: var(--danger);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
    }
    
    .file-preview:hover .file-remove {
      opacity: 1;
    }
    
    /* Estilos da área admin */
    .admin-section {
      margin-top: 40px;
    }
    
    .admin-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .admin-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .search-button {
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      padding: 0 20px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .search-button:hover {
      background-color: var(--primary-dark);
    }
    
    #adminPassword {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    
    #adminPassword:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    #accessDataBtn {
      background-color: var(--success);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      padding: 0 20px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    
    #accessDataBtn:hover {
      background-color: #3ab5d9;
    }
    
    /* Estilos da tabela */
    .table-responsive {
      overflow-x: auto;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: var(--white);
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--light-gray);
    }
    
    th {
      background-color: var(--primary);
      color: var(--white);
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    
    tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .photo-cell img {
      width: 60px;
      height: 60px;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      object-fit: cover;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .photo-cell img:hover {
      transform: scale(1.05);
    }
    
    /* Botões */
    .btn {
      padding: 8px 15px;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    /* Modal para visualização de fotos */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      overflow: auto;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      display: flex;
      flex-direction: column;
      background-color: var(--white);
      margin: 5% auto;
      padding: 20px;
      border-radius: var(--radius-md);
      max-width: 800px;
      max-height: 80vh;
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }
    
    .modal-body img {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
      border-radius: var(--radius-sm);
    }
    
    .close-modal {
      font-size: 24px;
      font-weight: bold;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close-modal:hover {
      color: var(--danger);
    }
    
    /* Status e badges */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background-color: rgba(76, 201, 240, 0.2);
      color: #189ab4;
    }
    
    .badge-warning {
      background-color: rgba(248, 150, 30, 0.2);
      color: #f3722c;
    }
    
    .badge-danger {
      background-color: rgba(247, 37, 133, 0.2);
      color: #f72585;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .message {
        max-width: 90%;
      }
      
      .admin-tools {
        flex-direction: column;
      }
      
      /* Ajustes específicos para mobile */
      #chatContainer {
        height: 70vh;
      }
      
      .file-preview img {
        width: 80px;
        height: 80px;
      }
      
      .input-group button {
        padding: 12px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 8px 10px;
      }
    }
    
    /* Estados */
    .hidden {
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
    
    .loading-spinner {
      border: 3px solid var(--light-gray);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Estilo para as perguntas enumeradas */
    .question-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary);
      color: var(--white);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 8px;
      font-weight: 600;
      font-size: 14px;
    }
    
    /* Progresso da entrevista */
    .progress-container {
      width: 100%;
      background-color: var(--light-gray);
      border-radius: 10px;
      margin-bottom: 20px;
      height: 8px;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 10px;
      background-color: var(--primary);
      transition: width 0.3s ease;
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: var(--dark);
      color: var(--white);
      text-align: center;
      border-radius: var(--radius-sm);
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Notificações */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      color: var(--white);
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification-success {
      background-color: var(--success);
    }
    
    .notification-error {
      background-color: var(--danger);
    }
    
    .notification-warning {
      background-color: var(--warning);
    }
    
    .notification-close {
      cursor: pointer;
      font-weight: bold;
    }
    
    /* Avatar placeholder */
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <div class="logo">
        <div class="logo-icon">MMG</div>
        <h1>Entrevista Digital</h1>
      </div>
      <div id="adminSection" class="admin-controls">
        <input id="adminPassword" type="password" placeholder="Senha de administrador">
        <button id="accessDataBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
          </svg>
          Acessar
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="applicationSection">
      <div class="card">
        <div class="progress-container">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <div id="chatContainer">
          <div id="chatMessages"></div>
          <div id="chatInputArea"></div>
        </div>
        <div id="loadingChat" class="loading hidden">
          <div class="loading-spinner"></div>
          Processando...
        </div>
      </div>
    </section>

    <section id="adminPanel" class="admin-section hidden">
      <div class="card">
        <h2>Painel Administrativo</h2>
        <div id="adminControls">
          <div class="admin-tools">
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nome ou CPF...">
            <button id="searchButton" class="search-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
              </svg>
              Buscar
            </button>
            <button id="resetSearch" class="search-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
              </svg>
              Limpar
            </button>
          </div>
          <div id="loadingData" class="loading hidden">
            <div class="loading-spinner"></div>
            Carregando dados...
          </div>
          <div id="noDataMessage" class="hidden">Nenhuma candidatura encontrada.</div>
          <div class="table-responsive">
            <table id="applicationsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Telefone</th>
                  <th>Idade</th>
                  <th>CPF</th>
                  <th>Data</th>
                  <th>Documentos</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="applicationsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal para visualização de fotos -->
  <div id="photoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Visualização de Documento</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <img id="modalImage" src="" alt="Documento">
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from './firebase-app.js';
    import { collection, addDoc, onSnapshot, query, doc, getDoc, where, or } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    document.addEventListener('DOMContentLoaded', () => {
      // Elementos do DOM
      const chatMessages = document.getElementById('chatMessages');
      const chatInputArea = document.getElementById('chatInputArea');
      const loadingChat = document.getElementById('loadingChat');
      const adminPasswordInput = document.getElementById('adminPassword');
      const accessDataBtn = document.getElementById('accessDataBtn');
      const adminPanel = document.getElementById('adminPanel');
      const applicationsTableBody = document.getElementById('applicationsTableBody');
      const loadingData = document.getElementById('loadingData');
      const noDataMessage = document.getElementById('noDataMessage');
      const photoModal = document.getElementById('photoModal');
      const modalImage = document.getElementById('modalImage');
      const modalTitle = document.getElementById('modalTitle');
      const closeModal = document.querySelector('.close-modal');
      const searchInput = document.getElementById('searchInput');
      const searchButton = document.getElementById('searchButton');
      const resetSearch = document.getElementById('resetSearch');
      const progressBar = document.getElementById('progressBar');

      // Configurações
      const ADMIN_PASSWORD = 'mmgadmin';
      let currentUserId = null;
      let currentQuestionIndex = 0;
      let collectedData = {};
      let applicationsSnapshot = [];

      // Fluxo de perguntas (agora com telefone)
      const questions = [
        { id: 'fullName', text: 'Para começar, qual é o seu nome completo?', type: 'text' },
        { id: 'age', text: 'Qual é a sua idade?', type: 'number' },
        { id: 'phone', text: 'Por favor, digite seu número de telefone com DDD:', type: 'text' },
        { id: 'cpf', text: 'Por favor, digite o número do seu CPF.', type: 'text' },
        { id: 'rg', text: 'Agora, o número do seu RG.', type: 'text' },
        { id: 'pis', text: 'E o número do seu PIS?', type: 'text' },
        { id: 'proofOfResidencePhoto', text: 'Por favor, envie uma foto do seu comprovante de residência.', type: 'file' },
        { id: 'cpfPhoto', text: 'Agora, uma foto da frente do seu CPF.', type: 'file' },
        { id: 'rgFrontPhoto', text: 'Envie uma foto da frente do seu RG.', type: 'file' },
        { id: 'rgBackPhoto', text: 'Por último, envie uma foto do verso do seu RG.', type: 'file' }
      ];

      // Inicialização
      initApplication();

      // Funções principais
      function initApplication() {
        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
        // Adiciona mensagem de boas-vindas
        addBotMessage('Olá! Bem-vindo ao processo de candidatura MMG. Vamos começar preenchendo algumas informações importantes:');
        updateProgressBar();
        displayQuestion();
        setupModal();
        setupSearch();
      }

      function displayQuestion() {
        if (currentQuestionIndex < questions.length) {
          const q = questions[currentQuestionIndex];
          // Adiciona número da pergunta e texto em negrito
          const questionText = `<span class="question-number">${currentQuestionIndex + 1}</span> <strong>${q.text}</strong>`;
          addBotMessage(questionText);
          renderInput(q.id, q.type);
        } else {
          addBotMessage('Obrigado por completar o formulário! Estamos processando sua candidatura...');
          chatInputArea.innerHTML = '';
          submitApplication();
        }
      }

      function updateProgressBar() {
        const progress = (currentQuestionIndex / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
      }

      function renderInput(id, type) {
        chatInputArea.innerHTML = '';
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        if (type === 'file') {
          const fileInputContainer = document.createElement('div');
          fileInputContainer.className = 'file-input-container';
          
          const fileInputLabel = document.createElement('label');
          fileInputLabel.className = 'file-input-label';
          fileInputLabel.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="margin-bottom: 8px;">
              <path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/>
              <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            <div>Clique para selecionar ou arraste o arquivo</div>
            <small>Tamanho máximo: 5MB</small>
          `;
          
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.id = id;
          fileInput.className = 'file-input';
          fileInput.accept = 'image/*';
          
          const previewContainer = document.createElement('div');
          previewContainer.className = 'file-preview-container';
          previewContainer.id = `${id}-preview`;
          
          const sendButton = document.createElement('button');
          sendButton.textContent = 'Enviar';
          sendButton.addEventListener('click', () => handleFileUpload(id, fileInput));

          fileInputContainer.appendChild(fileInput);
          fileInputContainer.appendChild(fileInputLabel);
          
          inputGroup.appendChild(fileInputContainer);
          inputGroup.appendChild(previewContainer);
          inputGroup.appendChild(sendButton);

          fileInput.addEventListener('change', (e) => {
            previewContainer.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
              if (file.size > 5 * 1024 * 1024) {
                showNotification('Arquivo muito grande. O tamanho máximo é 5MB.', 'error');
                return;
              }
              
              const reader = new FileReader();
              reader.onload = (event) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'file-preview';
                
                const img = document.createElement('img');
                img.src = event.target.result;
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'file-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  previewDiv.remove();
                  fileInput.value = '';
                });
                
                previewDiv.appendChild(img);
                previewDiv.appendChild(fileName);
                previewDiv.appendChild(removeBtn);
                previewContainer.appendChild(previewDiv);
              };
              reader.readAsDataURL(file);
            });
          });
          
          // Drag and drop
          fileInputLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInputLabel.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary');
            fileInputLabel.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
          });
          
          fileInputLabel.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileInputLabel.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--light-gray');
            fileInputLabel.style.backgroundColor = 'transparent';
          });
          
          fileInputLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputLabel.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--light-gray');
            fileInputLabel.style.backgroundColor = 'transparent';
            
            if (e.dataTransfer.files.length) {
              fileInput.files = e.dataTransfer.files;
              const event = new Event('change');
              fileInput.dispatchEvent(event);
            }
          });
        } else {
          const input = document.createElement('input');
          input.type = type;
          input.id = id;
          input.placeholder = `Digite seu ${id.replace(/([A-Z])/g, ' $1').toLowerCase()}...`;
          
          // Adiciona máscara para telefone se for o campo de phone
          if (id === 'phone') {
            input.addEventListener('input', function(e) {
              let value = e.target.value.replace(/\D/g, '');
              if (value.length > 11) value = value.substring(0, 11);
              
              // Formatação: (XX) XXXXX-XXXX
              if (value.length > 0) {
                value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7, 11)}`;
              }
              
              e.target.value = value;
            });
          }
          
          // Adiciona máscara para CPF
          if (id === 'cpf') {
            input.addEventListener('input', function(e) {
              let value = e.target.value.replace(/\D/g, '');
              if (value.length > 11) value = value.substring(0, 11);
              
              // Formatação: XXX.XXX.XXX-XX
              if (value.length > 0) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
              }
              
              e.target.value = value;
            });
          }
          
          const sendButton = document.createElement('button');
          sendButton.textContent = 'Enviar';
          sendButton.addEventListener('click', () => handleTextInput(id, input));

          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendButton.click();
          });

          inputGroup.appendChild(input);
          inputGroup.appendChild(sendButton);
        }

        chatInputArea.appendChild(inputGroup);
      }

      async function handleFileUpload(id, input) {
        const files = input.files;
        if (!files || files.length === 0) {
          addBotMessage('Por favor, selecione pelo menos um arquivo.');
          return;
        }

        loadingChat.classList.remove('hidden');
        try {
          const file = files[0];
          const base64 = await readFileAsBase64(file);
          collectedData[id] = base64;
          addUserMessage(`Arquivo enviado: ${file.name}`);
          input.value = '';
          currentQuestionIndex++;
          updateProgressBar();
          displayQuestion();
        } catch (error) {
          console.error('Erro ao processar arquivo:', error);
          showNotification('Erro ao processar arquivo. Tente novamente.', 'error');
        } finally {
          loadingChat.classList.add('hidden');
        }
      }

      function handleTextInput(id, input) {
        let value = input.value.trim();
        
        // Remove formatação do telefone antes de salvar
        if (id === 'phone') {
          value = value.replace(/\D/g, '');
          if (value.length < 10) {
            addBotMessage('Por favor, digite um número de telefone válido com DDD.');
            return;
          }
        }
        
        // Remove formatação do CPF antes de salvar
        if (id === 'cpf') {
          value = value.replace(/\D/g, '');
          if (value.length !== 11) {
            addBotMessage('Por favor, digite um CPF válido com 11 dígitos.');
            return;
          }
        }
        
        if (!value) {
          addBotMessage('Por favor, preencha este campo.');
          return;
        }

        collectedData[id] = value;
        addUserMessage(id === 'phone' ? formatPhoneNumber(value) : (id === 'cpf' ? formatCPF(value) : value));
        input.value = '';
        currentQuestionIndex++;
        updateProgressBar();
        displayQuestion();
      }

      function formatPhoneNumber(phone) {
        // Formata o telefone para exibição: (XX) XXXXX-XXXX
        if (phone.length === 11) {
          return `(${phone.substring(0, 2)}) ${phone.substring(2, 7)}-${phone.substring(7, 11)}`;
        }
        return phone;
      }
      
      function formatCPF(cpf) {
        // Formata o CPF para exibição: XXX.XXX.XXX-XX
        if (cpf.length === 11) {
          return `${cpf.substring(0, 3)}.${cpf.substring(3, 6)}.${cpf.substring(6, 9)}-${cpf.substring(9, 11)}`;
        }
        return cpf;
      }

      async function submitApplication() {
        loadingChat.classList.remove('hidden');
        try {
          // Verifica se todos os campos obrigatórios foram preenchidos
          const requiredFields = ['fullName', 'age', 'phone', 'cpf', 'rg', 'pis', 
                                'proofOfResidencePhoto', 'cpfPhoto', 'rgFrontPhoto', 'rgBackPhoto'];
          const missingFields = requiredFields.filter(field => !collectedData[field]);
          
          if (missingFields.length > 0) {
            throw new Error(`Faltam campos obrigatórios: ${missingFields.join(', ')}`);
          }

          const docRef = await addDoc(collection(db, 'applications'), {
            userId: currentUserId,
            ...collectedData,
            submissionDate: new Date().toISOString(),
            status: 'pending'
          });
          
          showNotification('Candidatura enviada com sucesso!', 'success');
          addBotMessage(`✅ <strong>Candidatura enviada com sucesso!</strong><br>Seu ID de registro é: <code>${docRef.id}</code>`);
          resetForm();
        } catch (error) {
          console.error('Erro ao enviar candidatura:', error);
          
          // Tratamento específico para erro de permissão
          if (error.message.includes('permission')) {
            addBotMessage('❌ <strong>Erro:</strong> Sem permissão para enviar. Verifique sua conexão e tente novamente.');
            showNotification('Erro de conexão. Verifique sua internet.', 'error');
          } else {
            addBotMessage(`❌ <strong>Erro ao enviar candidatura:</strong> ${error.message}`);
            showNotification('Erro ao enviar candidatura.', 'error');
          }
          
          // Permite tentar novamente
          const retryButton = document.createElement('button');
          retryButton.textContent = 'Tentar Novamente';
          retryButton.className = 'btn btn-primary';
          retryButton.style.marginTop = '10px';
          retryButton.addEventListener('click', submitApplication);
          chatInputArea.appendChild(retryButton);
        } finally {
          loadingChat.classList.add('hidden');
        }
      }

      function resetForm() {
        currentQuestionIndex = 0;
        collectedData = {};
        updateProgressBar();
        setTimeout(() => displayQuestion(), 3000);
      }

      // Funções de UI
      function addBotMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        messageDiv.innerHTML = text; // Usamos innerHTML para permitir formatação
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
          reader.readAsDataURL(file);
        });
      }
      
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <div>${message}</div>
          <div class="notification-close">&times;</div>
        `;
        
        document.body.appendChild(notification);
        
        notification.querySelector('.notification-close').addEventListener('click', () => {
          notification.remove();
        });
        
        setTimeout(() => {
          notification.remove();
        }, 5000);
      }

      // Funções do Admin
      accessDataBtn.addEventListener('click', () => {
        if (adminPasswordInput.value === ADMIN_PASSWORD) {
          adminPanel.classList.remove('hidden');
          loadApplications();
          showNotification('Acesso administrativo concedido', 'success');
        } else {
          showNotification('Senha incorreta!', 'error');
        }
      });

      function setupSearch() {
        searchButton.addEventListener('click', searchApplications);
        resetSearch.addEventListener('click', resetSearchResults);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') searchApplications();
        });
      }

      function searchApplications() {
        const searchTerm = searchInput.value.trim();
        if (!searchTerm) {
          showNotification('Digite um nome ou CPF para buscar', 'warning');
          return;
        }

        loadingData.classList.remove('hidden');
        applicationsTableBody.innerHTML = '';

        // Busca por nome (contendo o termo) ou CPF (igual ao termo)
        const q = query(
          collection(db, 'applications'),
          or(
            where('fullName', '>=', searchTerm),
            where('fullName', '<=', searchTerm + '\uf8ff'),
            where('cpf', '==', searchTerm.replace(/\D/g, ''))
          )
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
          loadingData.classList.add('hidden');
          
          if (snapshot.empty) {
            noDataMessage.classList.remove('hidden');
            noDataMessage.textContent = 'Nenhuma candidatura encontrada com os critérios de busca.';
            return;
          }

          renderApplicationsTable(snapshot);
          showNotification(`${snapshot.size} candidatura(s) encontrada(s)`, 'success');
        }, (error) => {
          console.error('Erro ao buscar candidaturas:', error);
          loadingData.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          noDataMessage.textContent = 'Erro ao buscar candidaturas.';
          showNotification('Erro na busca', 'error');
        });
      }

      function resetSearchResults() {
        searchInput.value = '';
        loadApplications();
      }

      function loadApplications() {
        loadingData.classList.remove('hidden');
        noDataMessage.classList.add('hidden');
        applicationsTableBody.innerHTML = '';

        const q = query(collection(db, 'applications'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
          loadingData.classList.add('hidden');
          applicationsSnapshot = snapshot; // Armazena o snapshot para uso posterior
          
          if (snapshot.empty) {
            noDataMessage.classList.remove('hidden');
            noDataMessage.textContent = 'Nenhuma candidatura encontrada.';
            return;
          }

          renderApplicationsTable(snapshot);
        }, (error) => {
          console.error('Erro ao carregar candidaturas:', error);
          loadingData.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          noDataMessage.textContent = 'Erro ao carregar candidaturas.';
          showNotification('Erro ao carregar dados', 'error');
        });
      }

      function renderApplicationsTable(snapshot) {
        applicationsTableBody.innerHTML = '';
        noDataMessage.classList.add('hidden');
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          // Formata o telefone para exibição
          const formattedPhone = data.phone ? 
            `(${data.phone.substring(0, 2)}) ${data.phone.substring(2, 7)}-${data.phone.substring(7, 11)}` : 
            'N/A';
          
          // Cria avatar com iniciais do nome
          let initials = 'NN';
          if (data.fullName) {
            const names = data.fullName.split(' ');
            initials = names[0][0] + (names.length > 1 ? names[names.length-1][0] : names[0][1] || '');
          }
          
          row.innerHTML = `
            <td><small>${doc.id.substring(0, 8)}</small></td>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div class="avatar">${initials.toUpperCase()}</div>
                <div>${data.fullName || 'N/A'}</div>
              </div>
            </td>
            <td>${formattedPhone}</td>
            <td>${data.age || 'N/A'}</td>
            <td>${data.cpf ? formatCPF(data.cpf) : 'N/A'}</td>
            <td>${new Date(data.submissionDate).toLocaleDateString()}</td>
            <td>
              <div style="display: flex; gap: 5px;">
                ${data.rgFrontPhoto ? `<img src="${data.rgFrontPhoto}" alt="RG Frente" class="document-thumbnail" style="cursor:pointer;" onclick="showModal('${data.rgFrontPhoto}', 'RG Frente')">` : ''}
                ${data.rgBackPhoto ? `<img src="${data.rgBackPhoto}" alt="RG Verso" class="document-thumbnail" style="cursor:pointer;" onclick="showModal('${data.rgBackPhoto}', 'RG Verso')">` : ''}
                ${data.cpfPhoto ? `<img src="${data.cpfPhoto}" alt="CPF" class="document-thumbnail" style="cursor:pointer;" onclick="showModal('${data.cpfPhoto}', 'CPF')">` : ''}
              </div>
            </td>
            <td>
              <button class="btn btn-primary btn-sm view-btn" data-id="${doc.id}">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                </svg>
                Ver
              </button>
            </td>
          `;
          
          applicationsTableBody.appendChild(row);
        });

        // Adiciona eventos aos botões
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', () => viewApplicationDetails(btn.dataset.id));
        });
      }

      async function viewApplicationDetails(appId) {
        const docRef = doc(db, 'applications', appId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          // Formata o telefone para exibição
          const formattedPhone = data.phone ? 
            `(${data.phone.substring(0, 2)}) ${data.phone.substring(2, 7)}-${data.phone.substring(7, 11)}` : 
            'Não informado';
          
          let details = `
            <div style="max-width: 800px; padding: 20px;">
              <h3 style="color: var(--primary); margin-bottom: 20px; border-bottom: 1px solid var(--light-gray); padding-bottom: 10px;">Detalhes da Candidatura</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                  <p><strong>ID:</strong> ${appId}</p>
                  <p><strong>Nome:</strong> ${data.fullName}</p>
                  <p><strong>Telefone:</strong> ${formattedPhone}</p>
                  <p><strong>Idade:</strong> ${data.age}</p>
                </div>
                <div>
                  <p><strong>CPF:</strong> ${formatCPF(data.cpf)}</p>
                  <p><strong>RG:</strong> ${data.rg}</p>
                  <p><strong>PIS:</strong> ${data.pis}</p>
                  <p><strong>Data:</strong> ${new Date(data.submissionDate).toLocaleString()}</p>
                </div>
              </div>
              
              <h4 style="margin: 20px 0 10px; color: var(--primary); border-bottom: 1px solid var(--light-gray); padding-bottom: 5px;">Documentos</h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <div>
                  <h5>Frente do RG</h5>
                  <img src="${data.rgFrontPhoto}" style="max-width:100%; cursor:pointer; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);" onclick="showModal('${data.rgFrontPhoto}', 'Frente do RG')">
                </div>
                <div>
                  <h5>Verso do RG</h5>
                  <img src="${data.rgBackPhoto}" style="max-width:100%; cursor:pointer; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);" onclick="showModal('${data.rgBackPhoto}', 'Verso do RG')">
                </div>
                <div>
                  <h5>CPF</h5>
                  <img src="${data.cpfPhoto}" style="max-width:100%; cursor:pointer; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);" onclick="showModal('${data.cpfPhoto}', 'CPF')">
                </div>
                <div>
                  <h5>Comprovante de Residência</h5>
                  <img src="${data.proofOfResidencePhoto}" style="max-width:100%; cursor:pointer; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);" onclick="showModal('${data.proofOfResidencePhoto}', 'Comprovante de Residência')">
                </div>
              </div>
            </div>
          `;
          
          // Cria um modal para mostrar os detalhes
          const detailModal = document.createElement('div');
          detailModal.className = 'modal';
          detailModal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
              <div class="modal-header">
                <h3>Detalhes da Candidatura</h3>
                <span class="close-modal">&times;</span>
              </div>
              <div class="modal-body">
                ${details}
              </div>
            </div>
          `;
          
          document.body.appendChild(detailModal);
          detailModal.style.display = 'block';
          
          // Adiciona evento para fechar o modal
          detailModal.querySelector('.close-modal').addEventListener('click', () => {
            detailModal.style.display = 'none';
            setTimeout(() => detailModal.remove(), 300);
          });
        } else {
          showNotification('Candidatura não encontrada!', 'error');
        }
      }
      
      // Configura o modal global para visualização de imagens
      function setupModal() {
        closeModal.addEventListener('click', () => {
          photoModal.style.display = 'none';
        });

        window.showModal = (imageSrc, title = 'Documento') => {
          modalImage.src = imageSrc;
          modalTitle.textContent = title;
          photoModal.style.display = 'block';
        };

        window.onclick = (event) => {
          if (event.target === photoModal) {
            photoModal.style.display = 'none';
          }
        };
      }
    });
  </script>
</body>
</html>