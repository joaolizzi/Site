<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrevista MMG</title>
  <style>
    :root {
      --primary: #3498db;
      --primary-hover: #2980b9;
      --secondary: #2ecc71;
      --secondary-hover: #27ae60;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --dark-hover: #1a252f;
      --gray: #95a5a6;
      --gray-light: #bdc3c7;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }
    
    body {
      background-color: #f5f7fa;
      color: var(--dark);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px 0;
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1, h2, h3 {
      color: var(--dark);
      margin-bottom: 20px;
    }
    
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 30px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    
    /* Estilos do Chat */
    #chatContainer {
      display: flex;
      flex-direction: column;
      height: 500px;
    }
    
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px 8px 0 0;
      border: 1px solid #e0e0e0;
      scroll-behavior: smooth;
    }
    
    .message {
      margin-bottom: 15px;
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      transition: var(--transition);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bot-message {
      background-color: var(--light);
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    
    .bot-message strong {
      font-weight: 600;
      color: var(--dark);
    }
    
    .user-message {
      background-color: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
      margin-left: auto;
      animation: fadeInRight 0.3s ease;
    }
    
    @keyframes fadeInRight {
      from { opacity: 0; transform: translateX(10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    #chatInputArea {
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 0 0 8px 8px;
      border: 1px solid #e0e0e0;
      border-top: none;
    }
    
    .input-group {
      display: flex;
      gap: 10px;
    }
    
    .input-group input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: var(--transition);
    }
    
    .input-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    
    .input-group button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .input-group button:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .input-group button:active {
      transform: translateY(0);
    }
    
    /* Estilos para upload de arquivos */
    .file-upload {
      margin-top: 10px;
      position: relative;
    }
    
    .file-upload label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .file-upload input[type="file"] {
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      position: absolute;
      z-index: -1;
    }
    
    .file-upload label.file-label {
      display: inline-block;
      padding: 12px 20px;
      background-color: var(--primary);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      text-align: center;
    }
    
    .file-upload label.file-label:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .file-upload label.file-label:active {
      transform: translateY(0);
    }
    
    .file-upload label.file-label i {
      margin-right: 8px;
    }
    
    .file-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    
    .file-preview {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
      transition: var(--transition);
    }
    
    .file-preview:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .file-preview img {
      display: block;
      max-width: 150px;
      max-height: 150px;
      object-fit: contain;
    }
    
    .file-preview .file-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 5px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-upload-status {
      margin-top: 10px;
      font-size: 14px;
      color: var(--gray);
    }
    
    .progress-bar {
      height: 5px;
      background-color: #e0e0e0;
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background-color: var(--primary);
      width: 0;
      transition: width 0.3s ease;
    }
    
    /* Estilos da área admin */
    .admin-section {
      margin-top: 40px;
    }
    
    .admin-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .admin-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      transition: var(--transition);
    }
    
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    
    .search-button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .search-button:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .search-button:active {
      transform: translateY(0);
    }
    
    #adminPassword {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      transition: var(--transition);
    }
    
    #adminPassword:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    
    #accessDataBtn {
      background-color: var(--success);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    #accessDataBtn:hover {
      background-color: var(--secondary-hover);
      transform: translateY(-1px);
    }
    
    #accessDataBtn:active {
      transform: translateY(0);
    }
    
    /* Estilos da tabela */
    .table-responsive {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: var(--primary);
      color: white;
      position: sticky;
      top: 0;
    }
    
    tr {
      transition: var(--transition);
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .photo-cell img {
      max-width: 100px;
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      transition: var(--transition);
    }
    
    .photo-cell img:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .view-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .view-btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .view-btn:active {
      transform: translateY(0);
    }
    
    /* Modal para visualização de fotos */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      overflow: auto;
      animation: fadeInModal 0.3s ease;
    }
    
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      display: flex;
      flex-direction: column;
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      max-height: 80vh;
      box-shadow: 0 5px 30px rgba(0,0,0,0.3);
      animation: slideInModal 0.3s ease;
    }
    
    @keyframes slideInModal {
      from { transform: translateY(-20px); }
      to { transform: translateY(0); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-body {
      flex: 1;
      overflow-y: auto;
    }
    
    .modal-body img {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
      border-radius: 4px;
    }
    
    .close-modal {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }
    
    .close-modal:hover {
      color: var(--dark);
      transform: rotate(90deg);
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .message {
        max-width: 90%;
      }
      
      .admin-tools {
        flex-direction: column;
      }
      
      /* Ajustes específicos para mobile */
      #chatContainer {
        height: 70vh;
      }
      
      .file-preview img {
        max-width: 100px;
        max-height: 100px;
      }
      
      .input-group button {
        padding: 12px;
      }
      
      .modal-content {
        margin: 10% auto;
        width: 90%;
      }
    }
    
    /* Estados */
    .hidden {
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
    
    /* Estilo para as perguntas enumeradas */
    .question-number {
      display: inline-block;
      background-color: var(--primary);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      margin-right: 8px;
      font-weight: bold;
    }
    
    /* Ícones */
    .icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 5px;
    }
    
    /* Notificações */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 20px;
      background-color: var(--success);
      color: white;
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
      display: flex;
      align-items: center;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    .notification.error {
      background-color: var(--danger);
    }
    
    .notification.warning {
      background-color: #f39c12;
    }
    
    .notification i {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1>Entrevista MMG</h1>
      <div id="adminSection" class="admin-controls">
        <input id="adminPassword" type="password" placeholder="Senha de administrador">
        <button id="accessDataBtn">Acessar Dados</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="applicationSection">
      <div class="card">
        <h2>Formulário de Candidatura</h2>
        <div id="chatContainer">
          <div id="chatMessages"></div>
          <div id="chatInputArea"></div>
        </div>
        <div id="loadingChat" class="loading hidden">Processando...</div>
      </div>
    </section>

    <section id="adminPanel" class="admin-section hidden">
      <div class="card">
        <h2>Painel Administrativo</h2>
        <div id="adminControls">
          <div class="admin-tools">
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nome ou CPF...">
            <button id="searchButton" class="search-button">Buscar</button>
            <button id="resetSearch" class="search-button">Limpar Busca</button>
          </div>
          <div id="loadingData" class="loading hidden">Carregando dados...</div>
          <div id="noDataMessage" class="hidden">Nenhuma candidatura encontrada.</div>
          <div class="table-responsive">
            <table id="applicationsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Telefone</th>
                  <th>Idade</th>
                  <th>CPF</th>
                  <th>Data</th>
                  <th>Frente RG</th>
                  <th>Verso RG</th>
                  <th>CPF</th>
                  <th>Comprovante</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="applicationsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal para visualização de fotos -->
  <div id="photoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Visualização de Documento</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <img id="modalImage" src="" alt="Documento">
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, doc, getDoc, where, or } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBfADQYaRc8EQFppGQnVNpD6XBai50totE",
      authDomain: "meuprojeto-257f0.firebaseapp.com",
      projectId: "meuprojeto-257f0",
      storageBucket: "meuprojeto-257f0.appspot.com",
      messagingSenderId: "710773486236",
      appId: "1:710773486236:web:e9529bab7f7ec7c80bf359",
      measurementId: "G-05PKZ06N10"
    };

    // Inicialize o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    document.addEventListener('DOMContentLoaded', () => {
      // Elementos do DOM
      const chatMessages = document.getElementById('chatMessages');
      const chatInputArea = document.getElementById('chatInputArea');
      const loadingChat = document.getElementById('loadingChat');
      const adminPasswordInput = document.getElementById('adminPassword');
      const accessDataBtn = document.getElementById('accessDataBtn');
      const adminPanel = document.getElementById('adminPanel');
      const applicationsTableBody = document.getElementById('applicationsTableBody');
      const loadingData = document.getElementById('loadingData');
      const noDataMessage = document.getElementById('noDataMessage');
      const photoModal = document.getElementById('photoModal');
      const modalImage = document.getElementById('modalImage');
      const modalTitle = document.getElementById('modalTitle');
      const closeModal = document.querySelector('.close-modal');
      const searchInput = document.getElementById('searchInput');
      const searchButton = document.getElementById('searchButton');
      const resetSearch = document.getElementById('resetSearch');

      // Configurações
      const ADMIN_PASSWORD = 'mmgadmin';
      const MAX_FILE_SIZE = 15 * 1024 * 1024; // 15MB
      let currentUserId = null;
      let currentQuestionIndex = 0;
      let collectedData = {};
      let applicationsSnapshot = [];

      // Fluxo de perguntas
      const questions = [
        { id: 'fullName', text: 'Para começar, qual é o seu nome completo?', type: 'text' },
        { id: 'age', text: 'Qual é a sua idade?', type: 'number' },
        { id: 'phone', text: 'Por favor, digite seu número de telefone com DDD:', type: 'text' },
        { id: 'cpf', text: 'Por favor, digite o número do seu CPF.', type: 'text' },
        { id: 'rg', text: 'Agora, o número do seu RG.', type: 'text' },
        { id: 'pis', text: 'E o número do seu PIS?', type: 'text' },
        { id: 'proofOfResidencePhoto', text: 'Por favor, envie uma foto do seu comprovante de residência.', type: 'file' },
        { id: 'cpfPhoto', text: 'Agora, uma foto da frente do seu CPF.', type: 'file' },
        { id: 'rgFrontPhoto', text: 'Envie uma foto da frente do seu RG.', type: 'file' },
        { id: 'rgBackPhoto', text: 'Por último, envie uma foto do verso do seu RG.', type: 'file' }
      ];

      // Funções de UI
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<i>${type === 'error' ? '⚠️' : '✓'}</i> ${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      function addBotMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        messageDiv.innerHTML = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function setupModal() {
        closeModal.addEventListener('click', () => {
          photoModal.style.display = 'none';
        });

        window.showModal = (imageSrc, title = 'Documento') => {
          modalImage.src = imageSrc;
          modalTitle.textContent = title;
          photoModal.style.display = 'block';
        };

        window.onclick = (event) => {
          if (event.target === photoModal) {
            photoModal.style.display = 'none';
          }
        };
      }

      // Funções principais
      function initApplication() {
        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
        addBotMessage('Olá! Vamos começar seu cadastro. Por favor, responda às seguintes perguntas:');
        displayQuestion();
        setupModal();
        setupSearch();
      }

      function displayQuestion() {
        if (currentQuestionIndex < questions.length) {
          const q = questions[currentQuestionIndex];
          const questionText = `<span class="question-number">${currentQuestionIndex + 1}</span> <strong>${q.text}</strong>`;
          addBotMessage(questionText);
          renderInput(q.id, q.type);
        } else {
          addBotMessage('Obrigado! Sua candidatura está sendo processada...');
          chatInputArea.innerHTML = '';
          submitApplication();
        }
      }

      function renderInput(id, type) {
        chatInputArea.innerHTML = '';
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        if (type === 'file') {
          const fileUploadDiv = document.createElement('div');
          fileUploadDiv.className = 'file-upload';
          
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.id = id;
          fileInput.accept = 'image/*';
          
          const fileLabel = document.createElement('label');
          fileLabel.htmlFor = id;
          fileLabel.className = 'file-label';
          fileLabel.innerHTML = '📁 Selecione o arquivo';
          
          const previewContainer = document.createElement('div');
          previewContainer.className = 'file-preview-container';
          previewContainer.id = `${id}-preview`;
          
          const statusDiv = document.createElement('div');
          statusDiv.className = 'file-upload-status';
          statusDiv.innerHTML = 'Tamanho máximo: 15MB';
          
          const progressBar = document.createElement('div');
          progressBar.className = 'progress-bar hidden';
          progressBar.innerHTML = '<div class="progress"></div>';
          
          const sendButton = document.createElement('button');
          sendButton.textContent = 'Enviar Arquivo';
          sendButton.addEventListener('click', () => handleFileUpload(id, fileInput, progressBar));

          fileUploadDiv.appendChild(fileInput);
          fileUploadDiv.appendChild(fileLabel);
          fileUploadDiv.appendChild(previewContainer);
          fileUploadDiv.appendChild(statusDiv);
          fileUploadDiv.appendChild(progressBar);
          
          inputGroup.appendChild(fileUploadDiv);
          inputGroup.appendChild(sendButton);

          fileInput.addEventListener('change', (e) => {
            previewContainer.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
              if (file.size > MAX_FILE_SIZE) {
                statusDiv.innerHTML = `❌ Arquivo muito grande (${(file.size / (1024 * 1024)).toFixed(2)}MB). O máximo é 15MB.`;
                statusDiv.style.color = 'var(--danger)';
                return;
              } else {
                statusDiv.innerHTML = `Arquivo selecionado: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)}MB)`;
                statusDiv.style.color = 'inherit';
              }
              
              const reader = new FileReader();
              reader.onload = (event) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'file-preview';
                
                const img = document.createElement('img');
                img.src = event.target.result;
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
                
                previewDiv.appendChild(img);
                previewDiv.appendChild(fileName);
                previewContainer.appendChild(previewDiv);
              };
              reader.readAsDataURL(file);
            });
          });
        } else {
          const input = document.createElement('input');
          input.type = type;
          input.id = id;
          input.placeholder = `Digite seu ${id.replace(/([A-Z])/g, ' $1').toLowerCase()}...`;
          
          if (id === 'phone') {
            input.addEventListener('input', function(e) {
              let value = e.target.value.replace(/\D/g, '');
              if (value.length > 11) value = value.substring(0, 11);
              
              if (value.length > 0) {
                value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7, 11)}`;
              }
              
              e.target.value = value;
            });
          }
          
          const sendButton = document.createElement('button');
          sendButton.textContent = 'Enviar';
          sendButton.addEventListener('click', () => handleTextInput(id, input));

          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendButton.click();
          });

          inputGroup.appendChild(input);
          inputGroup.appendChild(sendButton);
        }

        chatInputArea.appendChild(inputGroup);
      }

      async function handleFileUpload(id, input, progressBar) {
        const files = input.files;
        if (!files || files.length === 0) {
          showNotification('Por favor, selecione pelo menos um arquivo.', 'error');
          return;
        }

        const file = files[0];
        
        if (file.size > MAX_FILE_SIZE) {
          showNotification(`Arquivo muito grande (${(file.size / (1024 * 1024)).toFixed(2)}MB). O máximo é 15MB.`, 'error');
          return;
        }

        loadingChat.classList.remove('hidden');
        progressBar.classList.remove('hidden');
        const progress = progressBar.querySelector('.progress');
        
        try {
          addBotMessage('⏳ Enviando arquivo...');

          const timestamp = Date.now();
          const fileExtension = file.name.split('.').pop();
          const fileName = `${id}_${timestamp}.${fileExtension}`;
          const fileRef = ref(storage, `applications/${currentUserId}/${fileName}`);
          
          const uploadTask = uploadBytesResumable(fileRef, file);
          
          uploadTask.on('state_changed',
            (snapshot) => {
              const progressValue = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progress.style.width = `${progressValue}%`;
            },
            (error) => {
              console.error('Erro no upload:', error);
              showNotification('❌ Falha no envio. Tente novamente.', 'error');
            },
            async () => {
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              
              collectedData[id] = downloadURL;
              addUserMessage(`✅ Arquivo enviado: ${file.name}`);
              input.value = '';
              document.getElementById(`${id}-preview`).innerHTML = '';
              progressBar.classList.add('hidden');
              currentQuestionIndex++;
              displayQuestion();
              showNotification('Arquivo enviado com sucesso!');
            }
          );
          
        } catch (error) {
          console.error('Erro no upload:', error);
          showNotification('❌ Falha no envio. Tente novamente.', 'error');
        } finally {
          loadingChat.classList.add('hidden');
        }
      }

      function handleTextInput(id, input) {
        let value = input.value.trim();
        
        if (id === 'phone') {
          value = value.replace(/\D/g, '');
          if (value.length < 10) {
            showNotification('Por favor, digite um número de telefone válido com DDD.', 'error');
            return;
          }
        }
        
        if (!value) {
          showNotification('Por favor, preencha este campo.', 'error');
          return;
        }

        collectedData[id] = value;
        addUserMessage(id === 'phone' ? formatPhoneNumber(value) : value);
        input.value = '';
        currentQuestionIndex++;
        displayQuestion();
      }

      function formatPhoneNumber(phone) {
        if (phone.length === 11) {
          return `(${phone.substring(0, 2)}) ${phone.substring(2, 7)}-${phone.substring(7, 11)}`;
        }
        return phone;
      }

      async function submitApplication() {
        loadingChat.classList.remove('hidden');
        try {
          const requiredFields = ['fullName', 'age', 'phone', 'cpf', 'rg', 'pis', 
                                'proofOfResidencePhoto', 'cpfPhoto', 'rgFrontPhoto', 'rgBackPhoto'];
          const missingFields = requiredFields.filter(field => !collectedData[field]);
          
          if (missingFields.length > 0) {
            throw new Error(`Por favor, complete todos os campos: ${missingFields.join(', ')}`);
          }

          const applicationData = {
            userId: currentUserId,
            fullName: collectedData.fullName,
            age: collectedData.age,
            phone: collectedData.phone.replace(/\D/g, ''),
            cpf: collectedData.cpf.replace(/\D/g, ''),
            rg: collectedData.rg.replace(/\D/g, ''),
            pis: collectedData.pis.replace(/\D/g, ''),
            proofOfResidencePhoto: collectedData.proofOfResidencePhoto,
            cpfPhoto: collectedData.cpfPhoto,
            rgFrontPhoto: collectedData.rgFrontPhoto,
            rgBackPhoto: collectedData.rgBackPhoto,
            submissionDate: new Date().toISOString(),
            status: 'pending'
          };

          const docRef = await addDoc(collection(db, 'applications'), applicationData);
          
          addBotMessage(`✅ Candidatura #${docRef.id} enviada com sucesso!`);
          showNotification('Candidatura enviada com sucesso!');
          resetForm();
          
        } catch (error) {
          console.error('Erro:', error);
          addBotMessage(`❌ Erro: ${error.message}`);
          showNotification(`Erro: ${error.message}`, 'error');
          
          const retryBtn = document.createElement('button');
          retryBtn.textContent = 'Tentar Novamente';
          retryBtn.style.marginTop = '10px';
          retryBtn.addEventListener('click', submitApplication);
          chatInputArea.innerHTML = '';
          chatInputArea.appendChild(retryBtn);
        } finally {
          loadingChat.classList.add('hidden');
        }
      }

      function resetForm() {
        currentQuestionIndex = 0;
        collectedData = {};
        setTimeout(() => displayQuestion(), 3000);
      }

      // Funções do Admin
      function setupSearch() {
        searchButton.addEventListener('click', searchApplications);
        resetSearch.addEventListener('click', resetSearchResults);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') searchApplications();
        });
      }

      function searchApplications() {
        const searchTerm = searchInput.value.trim();
        if (!searchTerm) {
          showNotification('Por favor, digite um nome ou CPF para buscar.', 'error');
          return;
        }

        loadingData.classList.remove('hidden');
        applicationsTableBody.innerHTML = '';

        const q = query(
          collection(db, 'applications'),
          or(
            where('fullName', '>=', searchTerm),
            where('fullName', '<=', searchTerm + '\uf8ff'),
            where('cpf', '==', searchTerm.replace(/\D/g, ''))
        ));

        const unsubscribe = onSnapshot(q, (snapshot) => {
          loadingData.classList.add('hidden');
          
          if (snapshot.empty) {
            noDataMessage.classList.remove('hidden');
            noDataMessage.textContent = 'Nenhuma candidatura encontrada com os critérios de busca.';
            return;
          }

          renderApplicationsTable(snapshot);
          showNotification(`${snapshot.size} candidatura(s) encontrada(s).`);
        }, (error) => {
          console.error('Erro ao buscar candidaturas:', error);
          loadingData.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          noDataMessage.textContent = 'Erro ao buscar candidaturas.';
          showNotification('Erro ao buscar candidaturas.', 'error');
        });
      }

      function resetSearchResults() {
        searchInput.value = '';
        loadApplications();
        showNotification('Busca resetada.');
      }

      function loadApplications() {
        loadingData.classList.remove('hidden');
        noDataMessage.classList.add('hidden');
        applicationsTableBody.innerHTML = '';

        const q = query(collection(db, 'applications'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
          loadingData.classList.add('hidden');
          applicationsSnapshot = snapshot;
          
          if (snapshot.empty) {
            noDataMessage.classList.remove('hidden');
            noDataMessage.textContent = 'Nenhuma candidatura encontrada.';
            return;
          }

          renderApplicationsTable(snapshot);
          showNotification(`${snapshot.size} candidatura(s) carregada(s).`);
        }, (error) => {
          console.error('Erro ao carregar candidaturas:', error);
          loadingData.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          noDataMessage.textContent = 'Erro ao carregar candidaturas.';
          showNotification('Erro ao carregar candidaturas.', 'error');
        });
      }

      function renderApplicationsTable(snapshot) {
        applicationsTableBody.innerHTML = '';
        noDataMessage.classList.add('hidden');
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          const formattedPhone = data.phone ? 
            `(${data.phone.substring(0, 2)}) ${data.phone.substring(2, 7)}-${data.phone.substring(7, 11)}` : 
            'N/A';
          
          row.innerHTML = `
            <td>${doc.id}</td>
            <td>${data.fullName || 'N/A'}</td>
            <td>${formattedPhone}</td>
            <td>${data.age || 'N/A'}</td>
            <td>${data.cpf || 'N/A'}</td>
            <td>${new Date(data.submissionDate).toLocaleString()}</td>
            <td class="photo-cell">${renderPhotoCell(data.rgFrontPhoto)}</td>
            <td class="photo-cell">${renderPhotoCell(data.rgBackPhoto)}</td>
            <td class="photo-cell">${renderPhotoCell(data.cpfPhoto)}</td>
            <td class="photo-cell">${renderPhotoCell(data.proofOfResidencePhoto)}</td>
            <td>
              <button class="view-btn" data-id="${doc.id}">Ver Detalhes</button>
            </td>
          `;
          
          applicationsTableBody.appendChild(row);
        });

        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', () => viewApplicationDetails(btn.dataset.id));
        });
      }

      function renderPhotoCell(photoData) {
        if (!photoData) return 'N/A';
        return `<img src="${photoData}" alt="Documento" class="document-thumbnail" style="cursor:pointer;" onclick="showModal('${photoData}')">`;
      }

      async function viewApplicationDetails(appId) {
        const docRef = doc(db, 'applications', appId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          const formattedPhone = data.phone ? 
            `(${data.phone.substring(0, 2)}) ${data.phone.substring(2, 7)}-${data.phone.substring(7, 11)}` : 
            'Não informado';
          
          let details = `
            <div style="max-width: 800px; padding: 20px;">
              <h3 style="color: var(--primary); margin-bottom: 20px;">Detalhes da Candidatura</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                  <p><strong>ID:</strong> ${appId}</p>
                  <p><strong>Nome:</strong> ${data.fullName}</p>
                  <p><strong>Telefone:</strong> ${formattedPhone}</p>
                  <p><strong>Idade:</strong> ${data.age}</p>
                </div>
                <div>
                  <p><strong>CPF:</strong> ${data.cpf}</p>
                  <p><strong>RG:</strong> ${data.rg}</p>
                  <p><strong>PIS:</strong> ${data.pis}</p>
                  <p><strong>Data:</strong> ${new Date(data.submissionDate).toLocaleString()}</p>
                </div>
              </div>
              
              <h4 style="margin: 20px 0 10px; color: var(--primary);">Documentos</h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <div>
                  <h5>Frente do RG</h5>
                  <img src="${data.rgFrontPhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.rgFrontPhoto}', 'Frente do RG')">
                </div>
                <div>
                  <h5>Verso do RG</h5>
                  <img src="${data.rgBackPhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.rgBackPhoto}', 'Verso do RG')">
                </div>
                <div>
                  <h5>CPF</h5>
                  <img src="${data.cpfPhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.cpfPhoto}', 'CPF')">
                </div>
                <div>
                  <h5>Comprovante</h5>
                  <img src="${data.proofOfResidencePhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.proofOfResidencePhoto}', 'Comprovante')">
                </div>
              </div>
            </div>
          `;
          
          const detailModal = document.createElement('div');
          detailModal.className = 'modal';
          detailModal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
              <div class="modal-header">
                <h3>Detalhes da Candidatura</h3>
                <span class="close-modal">&times;</span>
              </div>
              <div class="modal-body">
                ${details}
              </div>
            </div>
          `;
          
          document.body.appendChild(detailModal);
          detailModal.style.display = 'block';
          
          detailModal.querySelector('.close-modal').addEventListener('click', () => {
            detailModal.style.display = 'none';
            setTimeout(() => detailModal.remove(), 300);
          });
        } else {
          showNotification('Candidatura não encontrada!', 'error');
        }
      }

      // Inicialização
      accessDataBtn.addEventListener('click', async () => {
        if (adminPasswordInput.value === ADMIN_PASSWORD) {
          try {
            loadingData.classList.remove('hidden');
            adminPanel.classList.remove('hidden');
            await loadApplications();
            showNotification('Painel administrativo acessado com sucesso!');
          } catch (error) {
            console.error('Erro ao acessar painel admin:', error);
            showNotification('Erro ao acessar painel administrativo.', 'error');
          } finally {
            loadingData.classList.add('hidden');
          }
        } else {
          showNotification('Senha incorreta!', 'error');
        }
      });

      initApplication();
    });
  </script>
</body>
</html>