<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Candidatura</title>
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2980b9;
      --success: #2ecc71;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --gray: #95a5a6;
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }
    
    body {
      background-color: #f5f7fa;
      color: var(--dark);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px 0;
      margin-bottom: 30px;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1, h2, h3 {
      color: var(--dark);
      margin-bottom: 20px;
    }
    
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 30px;
    }
    
    /* Estilos do Chat */
    #chatContainer {
      display: flex;
      flex-direction: column;
      height: 500px;
    }
    
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px 8px 0 0;
      border: 1px solid #e0e0e0;
    }
    
    .message {
      margin-bottom: 15px;
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
    }
    
    .bot-message {
      background-color: var(--light);
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    
    .user-message {
      background-color: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    
    #chatInputArea {
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 0 0 8px 8px;
      border: 1px solid #e0e0e0;
      border-top: none;
    }
    
    .input-group {
      display: flex;
      gap: 10px;
    }
    
    .input-group input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    
    .input-group button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .input-group button:hover {
      background-color: var(--secondary);
    }
    
    /* Estilos para upload de arquivos */
    .file-upload {
      margin-top: 10px;
    }
    
    .file-upload label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .file-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    
    .file-preview {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .file-preview img {
      display: block;
      max-width: 150px;
      max-height: 150px;
      object-fit: contain;
    }
    
    .file-preview .file-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 5px;
      font-size: 12px;
      text-align: center;
    }
    
    /* Estilos da área admin */
    .admin-section {
      margin-top: 40px;
    }
    
    .admin-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    #adminPassword {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    
    #accessDataBtn {
      background-color: var(--success);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: 600;
    }
    
    /* Estilos da tabela */
    .table-responsive {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: var(--primary);
      color: white;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .photo-cell img {
      max-width: 100px;
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Modal para visualização de fotos */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      overflow: auto;
    }
    
    .modal-content {
      display: flex;
      flex-direction: column;
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      max-height: 80vh;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-body {
      flex: 1;
      overflow-y: auto;
    }
    
    .modal-body img {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
    }
    
    .close-modal {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .input-group {
        flex-direction: column;
      }
      
      .message {
        max-width: 90%;
      }
    }
    
    /* Estados */
    .hidden {
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1>Sistema de Candidatura</h1>
      <div id="adminSection" class="admin-controls">
        <input id="adminPassword" type="password" placeholder="Senha de administrador">
        <button id="accessDataBtn">Acessar Dados</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="applicationSection">
      <div class="card">
        <h2>Formulário de Candidatura</h2>
        <div id="chatContainer">
          <div id="chatMessages"></div>
          <div id="chatInputArea"></div>
        </div>
        <div id="loadingChat" class="loading hidden">Processando...</div>
      </div>
    </section>

    <section id="adminPanel" class="admin-section hidden">
      <div class="card">
        <h2>Painel Administrativo</h2>
        <div id="adminControls">
          <div id="loadingData" class="loading hidden">Carregando dados...</div>
          <div id="noDataMessage" class="hidden">Nenhuma candidatura encontrada.</div>
          <div class="table-responsive">
            <table id="applicationsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Idade</th>
                  <th>CPF</th>
                  <th>Data</th>
                  <th>Frente RG</th>
                  <th>Verso RG</th>
                  <th>CPF</th>
                  <th>Comprovante</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="applicationsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal para visualização de fotos -->
  <div id="photoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Visualização de Documento</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <img id="modalImage" src="" alt="Documento">
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from './firebase-app.js';
    import { collection, addDoc, onSnapshot, query, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    document.addEventListener('DOMContentLoaded', () => {
      // Elementos do DOM
      const chatMessages = document.getElementById('chatMessages');
      const chatInputArea = document.getElementById('chatInputArea');
      const loadingChat = document.getElementById('loadingChat');
      const adminPasswordInput = document.getElementById('adminPassword');
      const accessDataBtn = document.getElementById('accessDataBtn');
      const adminPanel = document.getElementById('adminPanel');
      const applicationsTableBody = document.getElementById('applicationsTableBody');
      const loadingData = document.getElementById('loadingData');
      const noDataMessage = document.getElementById('noDataMessage');
      const photoModal = document.getElementById('photoModal');
      const modalImage = document.getElementById('modalImage');
      const modalTitle = document.getElementById('modalTitle');
      const closeModal = document.querySelector('.close-modal');

      // Configurações
      const ADMIN_PASSWORD = 'mmgadmin';
      let currentUserId = null;
      let currentQuestionIndex = 0;
      let collectedData = {};

      // Fluxo de perguntas
      const questions = [
        { id: 'fullName', text: 'Olá! Para começar, qual é o seu nome completo?', type: 'text' },
        { id: 'age', text: 'Qual é a sua idade?', type: 'number' },
        { id: 'cpf', text: 'Por favor, digite o número do seu CPF.', type: 'text' },
        { id: 'rg', text: 'Agora, o número do seu RG.', type: 'text' },
        { id: 'pis', text: 'E o número do seu PIS?', type: 'text' },
        { id: 'proofOfResidencePhoto', text: 'Por favor, envie uma foto do seu comprovante de residência.', type: 'file' },
        { id: 'cpfPhoto', text: 'Agora, uma foto da frente do seu CPF.', type: 'file' },
        { id: 'rgFrontPhoto', text: 'Envie uma foto da frente do seu RG.', type: 'file' },
        { id: 'rgBackPhoto', text: 'Por último, envie uma foto do verso do seu RG.', type: 'file' }
      ];

      // Inicialização
      initApplication();

      // Funções principais
      function initApplication() {
        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
        displayQuestion();
        setupModal();
      }

      function displayQuestion() {
        if (currentQuestionIndex < questions.length) {
          const q = questions[currentQuestionIndex];
          addBotMessage(q.text);
          renderInput(q.id, q.type);
        } else {
          addBotMessage('Obrigado! Sua candidatura está sendo processada...');
          chatInputArea.innerHTML = '';
          submitApplication();
        }
      }

      function renderInput(id, type) {
        chatInputArea.innerHTML = '';
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        if (type === 'file') {
          const label = document.createElement('label');
          label.setAttribute('for', id);
          label.textContent = 'Selecione o arquivo:';
          
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.id = id;
          fileInput.accept = 'image/*';
          fileInput.className = 'file-upload';
          
          const previewContainer = document.createElement('div');
          previewContainer.className = 'file-preview-container';
          previewContainer.id = `${id}-preview`;
          
          const sendButton = document.createElement('button');
          sendButton.textContent = 'Enviar';
          sendButton.addEventListener('click', () => handleFileUpload(id, fileInput));

          inputGroup.appendChild(label);
          inputGroup.appendChild(fileInput);
          inputGroup.appendChild(previewContainer);
          inputGroup.appendChild(sendButton);

          fileInput.addEventListener('change', (e) => {
            previewContainer.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
              const reader = new FileReader();
              reader.onload = (event) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'file-preview';
                
                const img = document.createElement('img');
                img.src = event.target.result;
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                
                previewDiv.appendChild(img);
                previewDiv.appendChild(fileName);
                previewContainer.appendChild(previewDiv);
              };
              reader.readAsDataURL(file);
            });
          });
        } else {
          const input = document.createElement('input');
          input.type = type;
          input.id = id;
          input.placeholder = `Digite seu ${id.replace(/([A-Z])/g, ' $1').toLowerCase()}...`;
          
          const sendButton = document.createElement('button');
          sendButton.textContent = 'Enviar';
          sendButton.addEventListener('click', () => handleTextInput(id, input));

          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendButton.click();
          });

          inputGroup.appendChild(input);
          inputGroup.appendChild(sendButton);
        }

        chatInputArea.appendChild(inputGroup);
      }

      async function handleFileUpload(id, input) {
        const files = input.files;
        if (!files || files.length === 0) {
          addBotMessage('Por favor, selecione pelo menos um arquivo.');
          return;
        }

        loadingChat.classList.remove('hidden');
        const file = files[0];
        const base64 = await readFileAsBase64(file);
        collectedData[id] = base64;
        addUserMessage(`Arquivo enviado: ${file.name}`);
        input.value = '';
        currentQuestionIndex++;
        loadingChat.classList.add('hidden');
        displayQuestion();
      }

      function handleTextInput(id, input) {
        const value = input.value.trim();
        if (!value) {
          addBotMessage('Por favor, preencha este campo.');
          return;
        }

        collectedData[id] = value;
        addUserMessage(value);
        input.value = '';
        currentQuestionIndex++;
        displayQuestion();
      }

      async function submitApplication() {
        loadingChat.classList.remove('hidden');
        try {
          const docRef = await addDoc(collection(db, 'applications'), {
            userId: currentUserId,
            ...collectedData,
            submissionDate: new Date().toISOString(),
            status: 'pending'
          });
          
          addBotMessage(`✅ Candidatura enviada com sucesso! Seu ID é: ${docRef.id}`);
          resetForm();
        } catch (error) {
          console.error('Erro ao enviar candidatura:', error);
          addBotMessage(`❌ Erro ao enviar candidatura: ${error.message}`);
        } finally {
          loadingChat.classList.add('hidden');
        }
      }

      function resetForm() {
        currentQuestionIndex = 0;
        collectedData = {};
        setTimeout(() => displayQuestion(), 3000);
      }

      // Funções de UI
      function addBotMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
          reader.readAsDataURL(file);
        });
      }

      // Funções do Admin
      accessDataBtn.addEventListener('click', () => {
        if (adminPasswordInput.value === ADMIN_PASSWORD) {
          adminPanel.classList.remove('hidden');
          loadApplications();
        } else {
          alert('Senha incorreta!');
        }
      });

      function loadApplications() {
        loadingData.classList.remove('hidden');
        noDataMessage.classList.add('hidden');
        applicationsTableBody.innerHTML = '';

        const q = query(collection(db, 'applications'));

        onSnapshot(q, (snapshot) => {
          loadingData.classList.add('hidden');
          
          if (snapshot.empty) {
            noDataMessage.classList.remove('hidden');
            noDataMessage.textContent = 'Nenhuma candidatura encontrada.';
            return;
          }

          applicationsTableBody.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const row = document.createElement('tr');
            
            // Células básicas
            row.innerHTML = `
              <td>${doc.id}</td>
              <td>${data.fullName || 'N/A'}</td>
              <td>${data.age || 'N/A'}</td>
              <td>${data.cpf || 'N/A'}</td>
              <td>${new Date(data.submissionDate).toLocaleString()}</td>
              <td class="photo-cell">${renderPhotoCell(data.rgFrontPhoto)}</td>
              <td class="photo-cell">${renderPhotoCell(data.rgBackPhoto)}</td>
              <td class="photo-cell">${renderPhotoCell(data.cpfPhoto)}</td>
              <td class="photo-cell">${renderPhotoCell(data.proofOfResidencePhoto)}</td>
              <td>
                <button class="view-btn" data-id="${doc.id}">Ver Detalhes</button>
              </td>
            `;
            
            applicationsTableBody.appendChild(row);
          });

          // Adiciona eventos aos botões
          document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => viewApplicationDetails(btn.dataset.id));
          });
        }, (error) => {
          console.error('Erro ao carregar candidaturas:', error);
          loadingData.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          noDataMessage.textContent = 'Erro ao carregar candidaturas.';
        });
      }

      function renderPhotoCell(photoData) {
        if (!photoData) return 'N/A';
        return `<img src="${photoData}" alt="Documento" class="document-thumbnail" style="cursor:pointer;" onclick="showModal('${photoData}')">`;
      }

      function setupModal() {
        closeModal.addEventListener('click', () => {
          photoModal.style.display = 'none';
        });

        window.showModal = (imageSrc, title = 'Documento') => {
          modalImage.src = imageSrc;
          modalTitle.textContent = title;
          photoModal.style.display = 'block';
        };

        window.onclick = (event) => {
          if (event.target === photoModal) {
            photoModal.style.display = 'none';
          }
        };
      }

      async function viewApplicationDetails(appId) {
        const docRef = doc(db, 'applications', appId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          let details = `
            <h3>Detalhes da Candidatura</h3>
            <p><strong>ID:</strong> ${appId}</p>
            <p><strong>Nome:</strong> ${data.fullName}</p>
            <p><strong>Idade:</strong> ${data.age}</p>
            <p><strong>CPF:</strong> ${data.cpf}</p>
            <p><strong>RG:</strong> ${data.rg}</p>
            <p><strong>PIS:</strong> ${data.pis}</p>
            <p><strong>Data:</strong> ${new Date(data.submissionDate).toLocaleString()}</p>
            
            <h4 style="margin-top:20px;">Documentos</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
              <div>
                <h5>Frente do RG</h5>
                <img src="${data.rgFrontPhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.rgFrontPhoto}', 'Frente do RG')">
              </div>
              <div>
                <h5>Verso do RG</h5>
                <img src="${data.rgBackPhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.rgBackPhoto}', 'Verso do RG')">
              </div>
              <div>
                <h5>CPF</h5>
                <img src="${data.cpfPhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.cpfPhoto}', 'CPF')">
              </div>
              <div>
                <h5>Comprovante</h5>
                <img src="${data.proofOfResidencePhoto}" style="max-width:100%; cursor:pointer;" onclick="showModal('${data.proofOfResidencePhoto}', 'Comprovante')">
              </div>
            </div>
          `;
          
          alert(details); // Substitua por um modal mais bonito se preferir
        } else {
          alert('Candidatura não encontrada!');
        }
      }
    });
  </script>
</body>
</html>